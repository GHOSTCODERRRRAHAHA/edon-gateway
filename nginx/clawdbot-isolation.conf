# Nginx Configuration for Clawdbot Gateway Network Isolation
#
# This configuration sets up a reverse proxy that only allows
# EDON Gateway IPs to access Clawdbot Gateway.
#
# Installation:
#   1. Copy to /etc/nginx/sites-available/clawdbot-isolation
#   2. Create symlink: ln -s /etc/nginx/sites-available/clawdbot-isolation /etc/nginx/sites-enabled/
#   3. Edit EDON_GATEWAY_IP below
#   4. Test: nginx -t
#   5. Reload: systemctl reload nginx
#
# Clawdbot Gateway should bind to 127.0.0.1:18789 (not 0.0.0.0)

# Upstream to Clawdbot Gateway (internal)
upstream clawdbot_backend {
    server 127.0.0.1:18789;
    keepalive 32;
}

# Server block for Clawdbot Gateway proxy
server {
    listen 18789;
    server_name _;

    # IP Whitelist: Only allow EDON Gateway
    # Replace with your EDON Gateway IP(s)
    # Multiple IPs: allow 10.0.0.10; allow 10.0.0.11; etc.
    allow 10.0.0.10;      # EDON Gateway IP - CHANGE THIS
    allow 127.0.0.1;      # Localhost (if EDON Gateway on same host)
    deny all;             # Deny all others

    # Logging
    access_log /var/log/nginx/clawdbot_access.log;
    error_log /var/log/nginx/clawdbot_error.log warn;

    # Security headers
    add_header X-Frame-Options "DENY" always;
    add_header X-Content-Type-Options "nosniff" always;

    # Proxy settings
    location / {
        proxy_pass http://clawdbot_backend;
        proxy_http_version 1.1;
        
        # Headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection "";
        
        # Timeouts
        proxy_connect_timeout 10s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        # Buffering
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
    }

    # Health check endpoint (optional - can be more permissive)
    location /health {
        allow 10.0.0.10;      # EDON Gateway IP
        allow 127.0.0.1;
        deny all;
        
        proxy_pass http://clawdbot_backend/health;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
    }
}

# Alternative: Token-based authentication instead of IP whitelist
# Uncomment this block and comment out the IP whitelist above if preferred
#
# server {
#     listen 18789;
#     server_name _;
#
#     # Check for EDON Gateway secret header
#     set $allowed 0;
#     if ($http_x_edon_secret = "your-secret-token-change-me") {
#         set $allowed 1;
#     }
#     if ($remote_addr = "127.0.0.1") {
#         set $allowed 1;
#     }
#
#     if ($allowed = 0) {
#         return 403;
#     }
#
#     access_log /var/log/nginx/clawdbot_access.log;
#     error_log /var/log/nginx/clawdbot_error.log warn;
#
#     location / {
#         proxy_pass http://clawdbot_backend;
#         proxy_http_version 1.1;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#     }
# }
